<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ghostfolio Agent</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0c0c0c;
      color: #e0e0e0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      background: #111111;
      padding: 12px 24px;
      border-bottom: 1px solid #2a2a2a;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .logo-video {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      object-fit: cover;
    }
    header a.back {
      color: #36cfb4;
      text-decoration: none;
      font-size: 14px;
      padding: 6px 14px;
      border-radius: 6px;
      border: 1px solid #2a2a2a;
      transition: background 0.2s;
    }
    header a.back:hover { background: #1a1a1a; }
    header h1 { font-size: 18px; font-weight: 600; color: #ffffff; }
    header span { font-size: 12px; color: #888; }
    .header-actions {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .header-actions button {
      padding: 6px 14px;
      font-size: 12px;
      background: #1a1a1a;
      border: 1px solid #2a2a2a;
      color: #e0e0e0;
      border-radius: 6px;
      cursor: pointer;
    }
    .header-actions button:hover { background: #252525; }
    .status {
      font-size: 12px;
      color: #36cfb4;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .status::before {
      content: '';
      width: 8px;
      height: 8px;
      background: #36cfb4;
      border-radius: 50%;
      display: inline-block;
    }
    .status.disconnected { color: #f87171; }
    .status.disconnected::before { background: #f87171; }
    .main-content { display: flex; flex: 1; overflow: hidden; }
    #sidebar {
      width: 260px;
      background: #111111;
      border-right: 1px solid #2a2a2a;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }
    #sidebar h3 {
      padding: 12px 16px;
      font-size: 13px;
      color: #36cfb4;
      border-bottom: 1px solid #2a2a2a;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .conv-item {
      padding: 10px 16px;
      cursor: pointer;
      border-bottom: 1px solid #1a1a1a;
      font-size: 13px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .conv-item:hover { background: #1a1a1a; }
    .conv-item.active { background: #1a2a2a; border-left: 3px solid #36cfb4; }
    .conv-item .conv-date { font-size: 10px; color: #666; margin-top: 2px; }
    .conv-item .conv-delete {
      float: right;
      color: #666;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 4px;
    }
    .conv-item .conv-delete:hover { background: #3b1111; color: #f87171; }
    #chat-area { flex: 1; display: flex; flex-direction: column; }
    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .message {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 12px;
      line-height: 1.5;
      font-size: 14px;
      white-space: pre-wrap;
    }
    .message.user {
      align-self: flex-end;
      background: #1a3a35;
      border: 1px solid #2a5a4a;
      border-bottom-right-radius: 4px;
    }
    .message.assistant {
      align-self: flex-start;
      background: #1a1a1a;
      border: 1px solid #2a2a2a;
      border-bottom-left-radius: 4px;
    }
    .message.assistant .tool-calls {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #333;
      font-size: 11px;
      color: #888;
    }
    .message.assistant .tool-calls span {
      background: #0a1a18;
      padding: 2px 8px;
      border-radius: 4px;
      margin-right: 4px;
      font-family: monospace;
      color: #36cfb4;
    }
    .verification {
      margin-top: 6px;
      padding-top: 6px;
      border-top: 1px solid #333;
      font-size: 11px;
    }
    .verification.pass { color: #36cfb4; }
    .verification.fail { color: #f87171; }
    .message.error {
      align-self: center;
      background: #3b1111;
      color: #f87171;
      font-size: 12px;
    }
    .typing {
      align-self: flex-start;
      color: #36cfb4;
      font-size: 13px;
      padding: 8px 16px;
    }
    .typing::after {
      content: '...';
      animation: dots 1.5s infinite;
    }
    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }
    #input-area {
      padding: 16px 24px;
      background: #111111;
      border-top: 1px solid #2a2a2a;
      display: flex;
      gap: 12px;
    }
    #input {
      flex: 1;
      padding: 12px 16px;
      border-radius: 8px;
      border: 1px solid #2a2a2a;
      background: #0c0c0c;
      color: #e0e0e0;
      font-size: 14px;
      outline: none;
      font-family: inherit;
    }
    #input:focus { border-color: #36cfb4; }
    #input::placeholder { color: #555; }
    button {
      padding: 12px 24px;
      border-radius: 8px;
      border: none;
      background: #1a3a35;
      color: #36cfb4;
      font-size: 14px;
      cursor: pointer;
      font-family: inherit;
      font-weight: 500;
    }
    button:hover { background: #245a4a; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .welcome {
      text-align: center;
      color: #666;
      margin: auto;
      font-size: 14px;
      line-height: 2;
    }
    .welcome video {
      width: 120px;
      height: 120px;
      border-radius: 16px;
      margin-bottom: 12px;
    }
    .welcome h2 { color: #36cfb4; font-size: 18px; margin-bottom: 8px; }
    .suggestions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      margin-top: 12px;
    }
    .suggestions button {
      padding: 8px 14px;
      font-size: 12px;
      background: #1a1a1a;
      border: 1px solid #2a2a2a;
      color: #e0e0e0;
    }
    .suggestions button:hover { background: #1a2a2a; border-color: #36cfb4; color: #36cfb4; }
  </style>
</head>
<body>
  <header>
    <video class="logo-video" autoplay loop muted playsinline src="/api/v1/agent/video"></video>
    <h1>Agent</h1>
    <span>AI Financial Assistant</span>
    <div class="header-actions">
      <button onclick="newConversation()">+ New Chat</button>
      <div class="status" id="status">Connected</div>
    </div>
  </header>

  <div class="main-content">
    <div id="sidebar">
      <h3>Conversations</h3>
      <div id="conv-list"></div>
    </div>
    <div id="chat-area">
      <div id="chat">
        <div class="welcome">
          <video autoplay loop muted playsinline src="/api/v1/agent/video"></video>
          <h2>Ask me about your portfolio</h2>
          <div>I can analyze your holdings, look up market data, review transactions, assess risk, and estimate taxes.</div>
          <div class="suggestions">
            <button onclick="sendSuggestion(this.textContent)">What does my portfolio look like?</button>
            <button onclick="sendSuggestion(this.textContent)">What have I bought recently?</button>
            <button onclick="sendSuggestion(this.textContent)">How risky is my portfolio?</button>
            <button onclick="sendSuggestion(this.textContent)">What are my unrealized gains?</button>
            <button onclick="sendSuggestion(this.textContent)">Am I too heavy in tech stocks?</button>
            <button onclick="sendSuggestion(this.textContent)">What's my estimated tax bill?</button>
          </div>
        </div>
      </div>
      <div id="input-area">
        <input id="input" type="text" placeholder="Ask about your portfolio..." autofocus />
        <button id="send" onclick="send()">Send</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '/api/v1/agent';

    function getToken() {
      return sessionStorage.getItem('auth-token')
        || localStorage.getItem('auth-token')
        || '';
    }

    let TOKEN = getToken();
    let messages = [];
    let currentConversationId = null;

    const statusEl = document.getElementById('status');
    const chat = document.getElementById('chat');
    const input = document.getElementById('input');
    const sendBtn = document.getElementById('send');
    const convListEl = document.getElementById('conv-list');

    if (!TOKEN) {
      statusEl.textContent = 'Not authenticated';
      statusEl.className = 'status disconnected';
      const t = prompt('No auth token found. Please sign into Ghostfolio first, then reload this page.\n\nOr paste your JWT token here:');
      if (t) TOKEN = t;
    }

    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }
    });

    // Load conversations on startup
    loadConversations();

    async function loadConversations() {
      if (!TOKEN) return;
      try {
        const res = await fetch(`${API_BASE}/conversations`, {
          headers: { 'Authorization': `Bearer ${TOKEN}` }
        });
        if (!res.ok) return;
        const data = await res.json();
        renderConversationList(data.conversations || []);
      } catch (e) { /* ignore */ }
    }

    function renderConversationList(conversations) {
      convListEl.innerHTML = '';
      for (const conv of conversations) {
        const div = document.createElement('div');
        div.className = 'conv-item' + (conv.id === currentConversationId ? ' active' : '');
        const dateStr = new Date(conv.updatedAt).toLocaleDateString();
        div.innerHTML = `
          <span class="conv-delete" onclick="event.stopPropagation(); deleteConversation('${conv.id}')">&#10005;</span>
          <div>${conv.title || 'Untitled'}</div>
          <div class="conv-date">${dateStr} &middot; ${conv._count?.messages || 0} msgs</div>
        `;
        div.addEventListener('click', () => loadConversation(conv.id));
        convListEl.appendChild(div);
      }
    }

    async function loadConversation(id) {
      if (!TOKEN) return;
      try {
        const res = await fetch(`${API_BASE}/conversations/${id}`, {
          headers: { 'Authorization': `Bearer ${TOKEN}` }
        });
        if (!res.ok) return;
        const data = await res.json();
        if (!data.conversation) return;

        currentConversationId = id;
        messages = [];
        chat.innerHTML = '';

        for (const msg of data.conversation.messages) {
          messages.push({ role: msg.role, content: msg.content });
          addMessage(msg.content, msg.role, msg.toolCalls);
        }

        // Update active state in sidebar
        document.querySelectorAll('.conv-item').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.conv-item').forEach(el => {
          if (el.querySelector('.conv-delete')?.getAttribute('onclick')?.includes(id)) {
            el.classList.add('active');
          }
        });
      } catch (e) { /* ignore */ }
    }

    async function deleteConversation(id) {
      if (!confirm('Delete this conversation?')) return;
      try {
        await fetch(`${API_BASE}/conversations/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${TOKEN}` }
        });
        if (id === currentConversationId) newConversation();
        loadConversations();
      } catch (e) { /* ignore */ }
    }

    function newConversation() {
      currentConversationId = null;
      messages = [];
      chat.innerHTML = `
        <div class="welcome">
          <video autoplay loop muted playsinline src="/api/v1/agent/video"></video>
          <h2>Ask me about your portfolio</h2>
          <div>I can analyze your holdings, look up market data, review transactions, assess risk, and estimate taxes.</div>
          <div class="suggestions">
            <button onclick="sendSuggestion(this.textContent)">What does my portfolio look like?</button>
            <button onclick="sendSuggestion(this.textContent)">What have I bought recently?</button>
            <button onclick="sendSuggestion(this.textContent)">How risky is my portfolio?</button>
            <button onclick="sendSuggestion(this.textContent)">What are my unrealized gains?</button>
            <button onclick="sendSuggestion(this.textContent)">Am I too heavy in tech stocks?</button>
            <button onclick="sendSuggestion(this.textContent)">What's my estimated tax bill?</button>
          </div>
        </div>
      `;
      document.querySelectorAll('.conv-item').forEach(el => el.classList.remove('active'));
    }

    function sendSuggestion(text) {
      input.value = text;
      send();
    }

    async function send() {
      const text = input.value.trim();
      if (!text) return;

      if (!TOKEN) TOKEN = getToken();
      if (!TOKEN) {
        addMessage('Please sign into Ghostfolio first, then reload this page.', 'error');
        return;
      }

      const welcome = chat.querySelector('.welcome');
      if (welcome) welcome.remove();

      addMessage(text, 'user');
      messages.push({ role: 'user', content: text });
      input.value = '';
      sendBtn.disabled = true;

      const typing = document.createElement('div');
      typing.className = 'typing';
      typing.textContent = 'Thinking';
      chat.appendChild(typing);
      chat.scrollTop = chat.scrollHeight;

      try {
        const res = await fetch(`${API_BASE}/chat`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${TOKEN}`
          },
          body: JSON.stringify({
            messages,
            conversationId: currentConversationId
          })
        });

        typing.remove();

        if (!res.ok) {
          const err = await res.text();
          addMessage(`Error ${res.status}: ${err}`, 'error');
          sendBtn.disabled = false;
          return;
        }

        const data = await res.json();

        // Track conversation ID for subsequent messages
        if (data.conversationId) {
          currentConversationId = data.conversationId;
          loadConversations();
        }

        messages.push({ role: 'assistant', content: data.message });
        addMessage(data.message, 'assistant', data.toolCalls, data.verification);

      } catch (err) {
        typing.remove();
        addMessage(`Network error: ${err.message}`, 'error');
      }

      sendBtn.disabled = false;
      input.focus();
    }

    function addMessage(text, role, toolCalls, verification) {
      const div = document.createElement('div');
      div.className = `message ${role}`;
      div.textContent = text;

      if (toolCalls?.length) {
        const tc = document.createElement('div');
        tc.className = 'tool-calls';
        tc.innerHTML = 'Tools used: ' + toolCalls.map(t => `<span>${t.tool}</span>`).join('');
        div.appendChild(tc);
      }

      if (verification && verification.checks?.length > 0) {
        const vDiv = document.createElement('div');
        vDiv.className = `verification ${verification.verified ? 'pass' : 'fail'}`;
        const icon = verification.verified ? '&#10003;' : '&#9888;';
        vDiv.innerHTML = `${icon} Verified: ${verification.checks.map(c => `${c.passed ? '&#10003;' : '&#10007;'} ${c.check}`).join(', ')}`;
        div.appendChild(vDiv);
      }

      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }
  </script>
</body>
</html>
