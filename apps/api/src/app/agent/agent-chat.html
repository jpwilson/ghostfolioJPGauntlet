<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ghostfolio Agent</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #1a1a2e;
      color: #e0e0e0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      background: #16213e;
      padding: 16px 24px;
      border-bottom: 1px solid #2a2a4a;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    header a.back {
      color: #a78bfa;
      text-decoration: none;
      font-size: 14px;
      padding: 6px 14px;
      border-radius: 6px;
      border: 1px solid #2a2a4a;
      transition: background 0.2s;
    }
    header a.back:hover { background: #222244; }
    header h1 { font-size: 18px; font-weight: 600; }
    header span { font-size: 12px; color: #888; }
    .status {
      margin-left: auto;
      font-size: 12px;
      color: #4ade80;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .status::before {
      content: '';
      width: 8px;
      height: 8px;
      background: #4ade80;
      border-radius: 50%;
      display: inline-block;
    }
    .status.disconnected { color: #f87171; }
    .status.disconnected::before { background: #f87171; }
    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .message {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 12px;
      line-height: 1.5;
      font-size: 14px;
      white-space: pre-wrap;
    }
    .message.user {
      align-self: flex-end;
      background: #0f3460;
      border-bottom-right-radius: 4px;
    }
    .message.assistant {
      align-self: flex-start;
      background: #222244;
      border-bottom-left-radius: 4px;
    }
    .message.assistant .tool-calls {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #333;
      font-size: 11px;
      color: #888;
    }
    .message.assistant .tool-calls span {
      background: #1a1a3e;
      padding: 2px 8px;
      border-radius: 4px;
      margin-right: 4px;
      font-family: monospace;
      color: #a78bfa;
    }
    .message.error {
      align-self: center;
      background: #3b1111;
      color: #f87171;
      font-size: 12px;
    }
    .typing {
      align-self: flex-start;
      color: #888;
      font-size: 13px;
      padding: 8px 16px;
    }
    .typing::after {
      content: '...';
      animation: dots 1.5s infinite;
    }
    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }
    #input-area {
      padding: 16px 24px;
      background: #16213e;
      border-top: 1px solid #2a2a4a;
      display: flex;
      gap: 12px;
    }
    #input {
      flex: 1;
      padding: 12px 16px;
      border-radius: 8px;
      border: 1px solid #2a2a4a;
      background: #1a1a2e;
      color: #e0e0e0;
      font-size: 14px;
      outline: none;
      font-family: inherit;
    }
    #input:focus { border-color: #4a4a8a; }
    #input::placeholder { color: #555; }
    button {
      padding: 12px 24px;
      border-radius: 8px;
      border: none;
      background: #0f3460;
      color: #e0e0e0;
      font-size: 14px;
      cursor: pointer;
      font-family: inherit;
    }
    button:hover { background: #1a4a80; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .welcome {
      text-align: center;
      color: #666;
      margin: auto;
      font-size: 14px;
      line-height: 2;
    }
    .welcome h2 { color: #888; font-size: 16px; margin-bottom: 8px; }
    .suggestions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      margin-top: 12px;
    }
    .suggestions button {
      padding: 8px 14px;
      font-size: 12px;
      background: #222244;
      border: 1px solid #2a2a4a;
    }
    .suggestions button:hover { background: #2a2a5a; }
  </style>
</head>
<body>
  <header>
    <a class="back" id="back-link" href="/en/">‚Üê Ghostfolio</a>
    <h1>Agent</h1>
    <span>AI Financial Assistant</span>
    <div class="status" id="status">Connected</div>
  </header>

  <div id="chat">
    <div class="welcome">
      <h2>Ask me about your portfolio</h2>
      <div>I can analyze your holdings, look up market data, and review your transactions.</div>
      <div class="suggestions">
        <button onclick="sendSuggestion(this.textContent)">What does my portfolio look like?</button>
        <button onclick="sendSuggestion(this.textContent)">What have I bought recently?</button>
        <button onclick="sendSuggestion(this.textContent)">Am I diversified enough?</button>
        <button onclick="sendSuggestion(this.textContent)">What's my biggest holding?</button>
        <button onclick="sendSuggestion(this.textContent)">How much cash do I have?</button>
        <button onclick="sendSuggestion(this.textContent)">Am I too heavy in tech stocks?</button>
      </div>
    </div>
  </div>

  <div id="input-area">
    <input id="input" type="text" placeholder="Ask about your portfolio..." autofocus />
    <button id="send" onclick="send()">Send</button>
  </div>

  <script>
    // Use relative URL so it works from any origin (port 4200 proxy or 3333 direct)
    const API = '/api/v1/agent/chat';

    // Auto-detect auth token from Ghostfolio's storage
    function getToken() {
      // Ghostfolio stores JWT as 'auth-token' in sessionStorage and localStorage
      return sessionStorage.getItem('auth-token')
        || localStorage.getItem('auth-token')
        || '';
    }

    let TOKEN = getToken();
    const messages = [];

    const statusEl = document.getElementById('status');

    if (!TOKEN) {
      statusEl.textContent = 'Not authenticated';
      statusEl.className = 'status disconnected';

      const t = prompt('No auth token found. Please sign into Ghostfolio first, then reload this page.\n\nOr paste your JWT token here:');
      if (t) {
        TOKEN = t;
      }
    }

    const chat = document.getElementById('chat');
    const input = document.getElementById('input');
    const sendBtn = document.getElementById('send');

    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }
    });

    function sendSuggestion(text) {
      input.value = text;
      send();
    }

    async function send() {
      const text = input.value.trim();
      if (!text) return;

      // Re-check token in case user logged in
      if (!TOKEN) TOKEN = getToken();
      if (!TOKEN) {
        addMessage('Please sign into Ghostfolio first, then reload this page.', 'error');
        return;
      }

      const welcome = chat.querySelector('.welcome');
      if (welcome) welcome.remove();

      addMessage(text, 'user');
      messages.push({ role: 'user', content: text });
      input.value = '';
      sendBtn.disabled = true;

      const typing = document.createElement('div');
      typing.className = 'typing';
      typing.textContent = 'Thinking';
      chat.appendChild(typing);
      chat.scrollTop = chat.scrollHeight;

      try {
        const res = await fetch(API, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${TOKEN}`
          },
          body: JSON.stringify({ messages })
        });

        typing.remove();

        if (!res.ok) {
          const err = await res.text();
          addMessage(`Error ${res.status}: ${err}`, 'error');
          sendBtn.disabled = false;
          return;
        }

        const data = await res.json();
        messages.push({ role: 'assistant', content: data.message });
        addMessage(data.message, 'assistant', data.toolCalls);

      } catch (err) {
        typing.remove();
        addMessage(`Network error: ${err.message}`, 'error');
      }

      sendBtn.disabled = false;
      input.focus();
    }

    function addMessage(text, role, toolCalls) {
      const div = document.createElement('div');
      div.className = `message ${role}`;
      div.textContent = text;

      if (toolCalls?.length) {
        const tc = document.createElement('div');
        tc.className = 'tool-calls';
        tc.innerHTML = 'Tools used: ' + toolCalls.map(t => `<span>${t.tool}</span>`).join('');
        div.appendChild(tc);
      }

      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }
  </script>
</body>
</html>
